<header id="app-header">
    <nav>
        <ul>
            <li><a href="<%= routes.home() %>"><%= await t.translate("core:navigation:home") %></a></li>
            <li>
                <details class="nav-dropdown">
                    <summary><%= await t.translate("lti:navigation:lti") %></summary>
                    <ul class="nav-dropdown-content">
                        <li><a href="<%= routes.lti.tools.list() %>"><%= await t.translate("lti:navigation:show-tools") %></a></li>
                        <li><a href="<%= routes.lti.tools.registerForm() %>"><%= await t.translate("lti:navigation:register-tool") %></a></li>
                    </ul>
                </details>
            </li>
            <% if (auth) { %>
                <li>
                    <details class="nav-dropdown">
                        <summary><%= auth.username %></summary>
                        <ul class="nav-dropdown-content">
                            <li><a href="<%= routes.auth.oidcLogout() %>"><%= await t.translate("auth:navigation:logout") %></a></li>
                        </ul>
                    </details>
                </li>
            <% } else { %>
                <li>
                    <a href="<%= routes.auth.registerForm() %>"><%= await t.translate("auth:navigation:register") %></a>
                </li>
                <li>
                    <a href="<%= routes.auth.loginForm() %>"><%= await t.translate("auth:navigation:login") %></a>
                </li>
            <% } %>
        </ul>
    </nav>
    <div>

    </div>
</header>

<script type="module">
    // https://codepen.io/kaiofelps/pen/jOemPZd
    document.querySelectorAll(".nav-dropdown .nav-dropdown-content").forEach((popup) => {
        const root = popup.parentElement;
        const trigger = root.querySelector("summary");

        window.addEventListener("resize", styleCenterOrLeft)
        window.addEventListener("load", styleCenterOrLeft)

        root.addEventListener("toggle", (event) => {
            if (root.open) {
                styleCenterOrLeft();
                window.addEventListener("click", closeOnClickOut);
                return;
            }

            window.removeEventListener("click", closeOnClickOut);
        })
        
        function closeOnClickOut(event) {
            const targetElement = event.target;
            const isNode = targetElement instanceof Node;
            if (!isNode || !root.contains(targetElement)) root.open = false;
        }

        function styleCenterOrLeft() {
            const availableWidthInScreen = window.visualViewport.width
            const distanceBetweenPopupAndCorner = popup.offsetLeft
            const popupWidth = popup.offsetWidth  
            const distanceBetweenTheMiddleOfTriggerAndLeftCorner = trigger.offsetLeft + (trigger.offsetWidth / 2)
            const leftInputMargin = Math.floor(distanceBetweenTheMiddleOfTriggerAndLeftCorner - (popupWidth / 2))
            const topInputMargin = Math.ceil(trigger.offsetTop + trigger.offsetHeight) + 8
            const visiblePopupWidthAndRightOffset = availableWidthInScreen - leftInputMargin

            if (leftInputMargin <= 20 || trigger.offsetLeft <= 20) {
                popup.style.transform = `translate3d(20px, ${topInputMargin}px, 0)`;
                return;
            }
            
            if (visiblePopupWidthAndRightOffset <= popup.offsetWidth + 20) {
                const responsiveLeftMarginInput = availableWidthInScreen - popup.offsetWidth - 20
                popup.style.transform = `translate3d(${responsiveLeftMarginInput}px, ${topInputMargin}px, 0)`;
                return;
            }
            
            popup.style.transform = `translate3d(${leftInputMargin}px, ${topInputMargin}px, 0)`;
        }
    })
</script>