<main class="main">
    <h1><%= title %></h1>
    <% if (flash?.success) { %>
        <div class="success-alert">
            <span><%= flash.success.message %></span><br>
        </div>
    <% } %>
    <% if (error) { %>
        <div class="error-alert">
            <span><%= error %></span><br>
        </div>
    <% } %>
    <form action="<%= routes.lti.tools.register() %>" method="post">
        <label>
            <span><%= await t.translate("lti:register-tool:labels:register-platform") %></span>
            <% (validationErrors?.registrationEndpoint ?? []).forEach(error => { %>
                <span class="error-span"><%- error.message %></span>
            <% }) %>
            <input
                type="text"
                name="registrationEndpoint"
                id="register-endpoint-input"
                style="width: fit-content;"
                value="<%= flash?.values?.registrationEndpoint %>"
            >
        </label>
        
        <button><%= await t.translate("lti:register-tool:buttons:register-tool") %></button>
    </form>

    <% if (initiateRegisterEndpoint) { %>
        <br>
        <hr>
        <br>
        <div id="registration-container" class="alert alert-info">
            <p><%- await t.translate("lti:register-tool:ready-to-go-paragraph") %></p>
            <button id="btn-start-registration" class="btn btn-primary">
               <%= await t.translate("lti:register-tool:buttons:finish-registration") %>
            </button>
        </div>

        <div id="success-message" style="display: none;" class="success-alert">
            <%- await t.translate("lti:register-tool:registration-success-message") %>
        </div>

        <script>
            const registerUrl = new URL("<%- initiateRegisterEndpoint %>");
            const btn = document.getElementById('btn-start-registration');

            btn.addEventListener('click', () => {
                const popup = window.open(
                    registerUrl, 
                    '<%= await t.translate("lti:register-tool:popup-title") %>', 
                    'width=800,height=600,resizable,scrollbars'
                );

                window.addEventListener("message", (event) => {
                    if (event.origin !== registerUrl.origin) return;

                    const mustClose = event.data && event.data.subject === "org.imsglobal.lti.close";

                    if (mustClose) {
                        popup.close();
                        document.getElementById('registration-container').style.display = 'none';
                        document.getElementById('success-message').style.display = 'block';
                    }
                }, false);
            });
        </script>
    <% } %>
</main>