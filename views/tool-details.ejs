<% 
function isUrl(value) {
    try {
        new URL(value);
        return true;
    } catch (_) {
        return false;
    }
}

const toolKeysToInsertManually = ["registeredMessages", "logoUri"];

const toolTableHeadings = {
    id: await t.translate("lti:tools-details:thead:id"),
    name: await t.translate("lti:tools-details:thead:name"),
    description: await t.translate("lti:tools-details:thead:description"),
    grantTypes: await t.translate("lti:tools-details:thead:grant-types"),
    initiateUri: await t.translate("lti:tools-details:thead:initiate-uri"),
    homePageUri: await t.translate("lti:tools-details:thead:home-page-uri"),
    logoUri: await t.translate("lti:tools-details:thead:logo-uri"),
    termsOfServiceUri: await t.translate("lti:tools-details:thead:tos-uri"),
    policyUri: await t.translate("lti:tools-details:thead:policy-uri"),
    contacts: await t.translate("lti:tools-details:thead:contacts"),
    registeredMessages: await t.translate("lti:tools-details:thead:registered-msgs"),
    requiredClaims: await t.translate("lti:tools-details:thead:required-claims"),
}
%>

<main class="main">
    <h1><%= title %></h1>
    <br>

    <div id="alerts-container">
        <% if (flash.successMessage) { %>
            <div class="success-alert">
                <span><%= flash.successMessage %></span>
            </div>
        <% } %>
    </div>

    <div>
        <button id="show-details"><%= await t.translate("lti:list-tools:buttons:tool-details") %></button>
        <button id="show-deployments"><%= await t.translate("lti:list-tools:buttons:list-deployments") %></button>
    </div>
    <br>
    <hr>
    <br>
    <div id="details" style="display: hidden;">
        <div class="vertical-table">
            <%  const keys = Object.keys(tool).filter(key => !toolKeysToInsertManually.includes(key));
                for (const key of keys) {
            %>
                <% if (!Array.isArray(tool[key])) { %>
                    <div class="item">
                        <header><%= toolTableHeadings[key] %></header>
                        <% if (isUrl(tool[key])) { %>
                            <a href="<%= tool[key] %>" target="_blank"><%= tool[key] %></a>
                        <% } else { %>
                            <span><%= tool[key] %></span>
                        <% } %>
                    </div>
                <% } else if (tool[key].length > 0) { %>
                    <div class="item">
                        <header><%= toolTableHeadings[key] %></header>
                        <ul style="margin-left: 24px;">
                            <% tool[key].forEach((item) => { %>
                                <li><%= item %></li>
                            <% }) %>
                        </ul>
                    </div>
                <% } %>
            <% } %>

            <div class="item">
                <header><%= toolTableHeadings.logoUri %></header>
                <span>
                    <img src="<%= tool.logoUri %>" alt="<%= toolTableHeadings.logoUri %>" style="max-width: 100px;">
                </span>
            </div>
        </div>
    </div>

    <div id="deployments" style="display: hidden;">
        <% if (deployments.length > 0) { %>
            <div id="deployments-table">
                <table class="base-table">
                    <colgroup>
                        <col style="width: 50%;" />
                        <col style="width: 30%;" />
                        <col style="width: 20%;" />
                    </colgroup>
                    <thead>
                        <th><%= await t.translate("lti:tools-details:thead:deployment-id") %></th>
                        <th><%= await t.translate("lti:tools-details:thead:deployment-label") %></th>
                        <th><%= await t.translate("table-headings:actions") %></th>
                    </thead>
                    <tbody>
                        <% for (const deployment of deployments) { %>
                            <tr data-deployment-id="<%= deployment.id %>">
                                <td><%= deployment.id %></td>
                                <td><%= deployment.label %></td>
                                <td>
                                    <ul>
                                        <li>
                                            <button
                                                class="deployment-delete-button"
                                                data-deployment-id="<%= deployment.id %>"
                                                data-endpoint="<%= routes.lti.deployments.delete(deployment.id) %>"
                                            >
                                                <%= await t.translate("lti:tools-details:buttons:delete-deployment") %>
                                            </button>
                                        </li>
                                        <li>
                                            <a href="<%= routes.lti.resourceLinks.list(deployment.id) %>">
                                                <%= await t.translate("lti:tools-details:buttons:see-assoc-resource-links") %>
                                            </a>
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
                <br>
            </div>
        <% } else { %>
            <div class="warning-alert">
                <span><%= await t.translate("lti:tools-details:no-tool-deployments") %></span>
            </div>
        <% } %>

        <button id="show-deployment-modal"><%= await t.translate("lti:tools-details:buttons:new-deploy") %></button>
    </div>

    <div id="invalid-tab" class="error-alert" style="display: hidden;">
        <span><%= await t.translate("lti:tools-details:invalid-tab-selected") %></span>
    </div>
</main>

<dialog class="base-modal" id="deploy-tool-dialog">
    <h2 style="margin-bottom: 8px;"><%= await t.translate("lti:deploy-tool:popup-title") %></h2>
    <form action="<%= routes.lti.deployments.deploy(tool.id) %>" method="post">
        <input type="hidden" name="activeTab" class="active-tab-input" value="">
        <input type="hidden" name="withDeployModalOpen" value="true">
        <label>
            <span><%= await t.translate("lti:tools-details:thead:deployment-label") %></span>
            <% (validationErrors?.label ?? []).forEach(error => { %>
                <span class="error-span"><%= error.message %></span>
            <% }) %>
            <input type="text" name="label" value="<%= flash?.values?.label %>">
        </label>
        <button type="submit"><%= await t.translate("buttons:confirm") %></button>
        <button id="close-deployment-modal" type="button"><%= await t.translate("buttons:cancel") %></button>
    </form>
</dialog>

<dialog class="base-modal" id="delete-deployment-dialog">
    <p><%= await t.translate("lti:delete-tool-deployment:warning-p1") %></p>
    <br>
    <form id="delete-deployment-form" method="dialog">
        <input type="hidden" name="endpoint" id="delete-deployment-form-endpoint">
        <input type="hidden" name="activeTab" class="active-tab-input" value="">
        <button type="submit" value="confirm"><%= await t.translate("buttons:confirm") %></button>
        <button id="close-deployment-removal-modal" type="reset" value="cancel"><%= await t.translate("buttons:cancel") %></button>
    </form>
</dialog>

<script id="delete-deployment-dialog-script" type="module">
    const dialog = document.getElementById("delete-deployment-dialog");
    const close = document.getElementById("close-deployment-removal-modal");
    const endpointInput = document.getElementById("delete-deployment-form-endpoint");

    const alertsContainer = document.getElementById("alerts-container");

    const triggers = document
        .querySelectorAll(".deployment-delete-button")
        .forEach(trigger => {
            trigger.addEventListener("click", () => {
                endpointInput.value = trigger.getAttribute("data-endpoint");
                dialog.showModal();
            })
        });

    close.addEventListener("click", () => dialog.close());

    dialog.addEventListener("close", async () => {
        if (dialog.returnValue !== "confirm") return;

        const endpoint = endpointInput.value;
        const response = await fetch(endpoint, { method: "DELETE" });

        const alert = document.createElement("div");

        if (!response.ok) {
            let message;
            try {
                const body = await response.json();
                message = body.error;
            } catch (_error) {
                message = "<%= await t.translate('core:errors:internal-error-message') %>";
            }

            alert.classList.add("error-alert");
            alert.innerHTML = `<span>${message}</span>`;
        }
        else {
            const { successMessage, deploymentId } = await response.json();
            alert.classList.add("success-alert");
            alert.innerHTML = `<span>${successMessage}</span>`;

            updateTable(deploymentId);
        }

        alertsContainer.innerHTML = "";
        alertsContainer.appendChild(alert);
    })

    function updateTable(deploymentId) {
        const deploymentsContainer = document.getElementById("deployments");
        const deploymentsTable = document.getElementById("deployments-table");
        const row = deploymentsTable.querySelector(`[data-deployment-id="${deploymentId}"]`);
        row.remove();

        const tableIsEmpty = deploymentsTable.querySelector("tbody").childElementCount === 0;
        if (!tableIsEmpty) return; 

        const noDeploymentsAlert = document.createElement("div");
        noDeploymentsAlert.classList.add("warning-alert");
        noDeploymentsAlert.innerHTML = `<span><%= await t.translate("lti:tools-details:no-tool-deployments") %></span>`;

        deploymentsTable.remove();
        if (deploymentsContainer.childElementCount) {
            const firstElement = deploymentsContainer.firstElementChild;
            firstElement.insertAdjacentElement("beforebegin", noDeploymentsAlert);
        }
        else {
            deploymentsContainer.appendChild(noDeploymentsAlert);
        }
    }
</script>

<%# this syntax error is related to the ejs visual studio code extension; the code works tho #%>
<script id="deploy-dialog-script" type="module">
    const trigger = document.getElementById("show-deployment-modal");
    const close = document.getElementById("close-deployment-modal");
    const dialog = document.getElementById("deploy-tool-dialog");

    trigger.addEventListener("click", () => dialog.showModal());
    close.addEventListener("click", () => {
        dialog.close();
    });

    <% if(flash?.values?.withDeployModalOpen ?? false) { %>
        dialog.showModal();
    <% } %>
</script>

<script id="sections-tabs-script" type="module">
    const activeTabInputs = document.querySelectorAll(".active-tab-input");

    const Tabs = Object.freeze({
        Deployments: "#tooldeployments",
        Details: "#tooldetails"
    });

    const availableTabs = Object.values(Tabs);

    const Containers = Object.freeze({
        [Tabs.Deployments]: document.getElementById("deployments"),
        [Tabs.Details]: document.getElementById("details"),
        invalidTab: document.getElementById("invalid-tab")
    });


    function updateContent() {
        const activeTab = window.location.hash;

        Containers.invalidTab.hidden = false;
        Object.values(Tabs).forEach((tabContainerId) => {
            Containers[tabContainerId].hidden = true;
        });

        if (!availableTabs.includes(activeTab)) {
            return;
        }

        Containers.invalidTab.hidden = true;
        Containers[activeTab].hidden = false;

        activeTabInputs.forEach(input => input.value = activeTab);
    }

    window.addEventListener("hashchange", updateContent);
    window.addEventListener("load", () => {
        const flashActiveTab = "<%= flash?.values?.activeTab ?? flash?.activeTab %>";

        if (flashActiveTab) window.location.hash = flashActiveTab;

        updateContent();
    });

    const TabTriggers = Object.freeze({
        Deployments: document.getElementById("show-deployments"),
        Details: document.getElementById("show-details"),
    });

    Object.keys(Tabs).forEach((tabKey) => {
        TabTriggers[tabKey].addEventListener("click", () => {
            window.location.hash = Tabs[tabKey];
        })
    })
</script>
